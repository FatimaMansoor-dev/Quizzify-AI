<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuizXpert - User Profile</title>
  <style>
    /* RESET / BASIC STYLES */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background-color: #f8f9fa;
      color: #212529;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    /* NAVBAR */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #ffffff;
      padding: 0.75rem 1rem;
    }
    .navbar-left,
    .navbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .navbar-brand {
      font-size: 1.2rem;
      font-weight: 600;
      font-family: cursive;
      color: #7a4dc1;
    }
    .user-button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .user-button img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    /* AI SUGGESTIONS BUTTON */
    .ai-suggestions-btn {
      background-color: #7a4dc1;
      color: #ffffff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 0 10px rgba(122,77,193,0.7);
      animation: glow 1.5s infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px rgba(122,77,193,0.7); }
      to   { box-shadow: 0 0 20px rgba(122,77,193,1); }
    }
    /* GENERATE PPT BUTTON */
    .generate-ppt-btn {
      background-color: #28a745;
      color: #ffffff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      margin-left: 0.5rem;
      box-shadow: 0 0 10px rgba(40,167,69,0.7);
      animation: glow-green 1.5s infinite alternate;
    }
    @keyframes glow-green {
      from { box-shadow: 0 0 10px rgba(40,167,69,0.7); }
      to   { box-shadow: 0 0 20px rgba(40,167,69,1); }
    }
    /* MAIN WRAPPER */
    .main-wrapper {
      max-width: 1200px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }
    /* STREAK TRACKER */
    .streak-tracker {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .streak-tracker h2 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #343a40;
    }
    /* BADGES BLOCK */
    .badges-block {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .badges-block h2 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #343a40;
    }
    .badges-block p {
      margin-bottom: 0.3rem;
      color: #495057;
    }
    /* QUIZZES HEADER SECTION */
    .quizzes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      color: #7a4dc1;
    }
    .quizzes-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .quizzes-header .create-quiz-btn {
      background-color: #7a4dc1;
      color: #ffffff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s ease;
    }
    .quizzes-header .create-quiz-btn:hover {
      background-color: #6939a8;
    }
    .quizzes-subtext {
      color: #6c757d;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }
    /* QUIZ CARD */
    .quiz-card {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .quiz-card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: #212529;
    }
    .quiz-card .quiz-meta {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }
    .quiz-card pre {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 0.5rem;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 0.9rem;
      color: #343a40;
      max-height: 300px;
      overflow-y: auto;
    }
    .quiz-card button {
      background-color: #7a4dc1;
      color: #fff;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .quiz-card button:hover {
      background-color: #6939a8;
    }
    /* CALENDAR Layout */
    #calendar {
      display: flex;
      gap: 20px; 
      overflow-x: auto; 
      padding: 10px 0; 
    }
    .month-container {
      flex: 1 0 auto;
      max-width: 120px;
      text-align: center;
      padding: 5px;
      margin-right: 15px;
    }
    .month-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 10px;
      white-space: nowrap;
    }
    .week-row {
      display: grid;
      grid-template-columns: repeat(7, 12px);
      gap: 5px;
      margin-bottom: 5px;
      justify-content: center;
    }
    .day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      cursor: pointer;
    }
    .day span { display: none; }
    .empty {
      background-color: transparent;
      border: none;
      cursor: default;
    }
    .highlight {
      background-color: #7a4dc1 !important;
      border-color: #7a4dc1 !important;
    }
    .active {
      outline: 2px solid #ffc107;
    }
    /* SIDEBAR */
    #sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 0;
      height: 40%;
      background-color: #fff;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      transition: width 0.5s, padding 0.5s;
      padding: 0;
    }
    #sidebar.open {
      width: 250px;
      padding: 0 1rem;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid #eee;
    }
    .sidebar-brand {
      font-size: 1.1rem;
      font-weight: 600;
      color: #7a4dc1;
    }
    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      color: #333;
    }
    .sidebar-section { margin: 1rem 0; }
    .sidebar-section h3 { font-size: 1rem; margin-bottom: 0.5rem; color: #333; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu li { margin-bottom: 0.75rem; }
    .sidebar-menu li a { color: #333; text-decoration: none; font-size: 0.95rem; transition: color 0.2s ease; }
    .sidebar-menu li a:hover { color: #7a4dc1; }
    .logout-btn {
      background-color: #dc3545;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .logout-btn:hover { background-color: #c82333; }
    /* RESPONSIVE */
    @media (max-width: 768px) {
      #sidebar.open { width: 100%; }
      .navbar-left, .navbar-right { gap: 0.5rem; }
      .navbar-brand { font-size: 1rem; }
      .main-wrapper { padding: 0 0.5rem; }
      .week-row { grid-template-columns: repeat(7, 10px); gap: 3px; }
      .day { width: 10px; height: 10px; }
      .quiz-card pre { max-height: 200px; }
    }
    /* CHATBOT */
    #chatbot-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      display: none;
      flex-direction: column;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
      font-size: 14px;
      padding-top: 30px;
    }
    #chatbot-close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #333;
    }
    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .chat-message { margin-bottom: 10px; padding: 5px 10px; border-radius: 4px; max-width: 80%; }
    .chat-message.ai { background-color: #F1F0F0; align-self: flex-start; }
    .chat-message.user { background-color: #DCF8C6; align-self: flex-end; }
    #chat-input-container { display: flex; border-top: 1px solid #ccc; }
    #chat-input { flex: 1; border: none; padding: 10px; font-size: 14px; }
    #chat-input:focus { outline: none; }
    #chat-send-btn {
      background-color: #7a4dc1;
      border: none;
      color: #fff;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 14px;
    }
    #chat-send-btn:hover { background-color: #6939a8; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-left">
      <div class="navbar-brand">QuizXpert</div>
    </div>
    <div class="navbar-right">
      <button class="ai-suggestions-btn"
        onclick="window.location.href='/validation_go'">
  Validate your quiz
</button>

      <button class="ai-suggestions-btn" onclick="getAISuggestions()">
        Get AI Suggestions
      </button>
      <button class="generate-ppt-btn" onclick="window.location.href='/options?pres=ppt'">
        Generate PPT
      </button>
      <button class="user-button" onclick="openSidebar()">
        <img src="../static/user.png" alt="User">
      </button>
    </div>
  </nav>

  <!-- MAIN WRAPPER -->
  <div class="main-wrapper">
    <!-- STREAK TRACKER -->
    <div class="streak-tracker">
      <div id="calendar"></div>
    </div>
    <!-- BADGES BLOCK -->
    <div class="badges-block">
      <h2>Your Badges</h2>
      <div id="badgeList"></div>
    </div>
    <!-- QUIZZES HEADER -->
    <div class="quizzes-header">
      <h1>Quizzes</h1>
      <div>
        <button class="create-quiz-btn" onclick="window.location.href='/options?pres=false'">
          Create new quiz
        </button>
      </div>
    </div>
    <div class="quizzes-subtext">
      You can effortlessly list, delete, edit, and create new exams.
    </div>
    <!-- DYNAMIC QUIZ CARDS -->
    <div id="quizzesContainer"></div>
  </div> <!-- END main-wrapper -->

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">{{ first_name }}'s Classroom</div>
      <button class="close-btn" onclick="closeSidebar()">×</button>
    </div>
    <div class="sidebar-section">
      <h3>Welcome, {{ first_name }} {{ last_name }}!</h3>
    </div>
    <div class="sidebar-section">
      <ul class="sidebar-menu">
        <li id="streakTrackerSidebar" style="margin-bottom: 0.5rem; font-weight: 600;"></li>
        <li>Last Score: <span id="lastScore">N/A</span></li>
        <li>Maximum Score: <span id="maxScore">N/A</span></li>
      </ul>
    </div>
    <div class="sidebar-section">
      <button class="logout-btn" onclick="window.location.href='/'">
        Logout
      </button>
    </div>
  </div>
  <!-- End SIDEBAR -->

  <!-- Hidden fields passed from Flask -->
  <input type="hidden" id="userData" value='{{ user_data|tojson|safe }}'>
  <input type="hidden" id="badges" value='{{ message|default([])|tojson|safe }}'>

  <!-- Hidden data for quiz dates, etc. -->
  <div id="quizDatesData" data-quiz-dates='{{ quiz_dates | tojson }}'></div>

  <!-- Container elements for dynamically rendered content -->
  <div id="quizContainer"></div>
  <div id="badgeContainer"></div>

  <!-- Chatbot box with close button -->
  <div id="chatbot-box">
    <button id="chatbot-close-btn" onclick="closeChatbot()">×</button>
    <div id="chat-messages"></div>
    <div id="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type your message..." />
      <button id="chat-send-btn" onclick="sendChatMessage()">Send</button>
    </div>
  </div>

  <!-- JavaScript to render quizzes, badges, sidebar and chatbot -->
  <script>
    // Get and parse the JSON data from hidden inputs
    let rawUserData = document.getElementById("userData").value;
    let rawBadges = document.getElementById("badges").value;
    var userData = JSON.parse(rawUserData);
    var badgeData = JSON.parse(rawBadges);
    console.log("User data:", userData);
    console.log("Badge data:", badgeData);

    if (badgeData.includes("First Step Badge")) {
      const img = document.createElement("img");
      img.src = "../static/firststep.png"; 
      img.alt = "First Step Badge";
      document.getElementById("badgeList").appendChild(img);
    }

    // Render quiz attempts
    const quizzesContainer = document.getElementById("quizzesContainer");
    let UserData = JSON.parse(userData);

    const badgeMessages = badgeData;
    console.log("Badge messages:", badgeMessages);
  </script>

  <script>
    /****************************************************
     * SIDEBAR TOGGLE FUNCTIONS
     ****************************************************/
    function openSidebar() {
      const sidebar = document.getElementById("sidebar");
      if (sidebar) {
        sidebar.classList.add("open");
        const streakTrackerSidebar = document.getElementById("streakTrackerSidebar");
        if (streakTrackerSidebar) {
          const quizDatesElement = document.getElementById("quizDatesData");
          const quizDates = JSON.parse(quizDatesElement.getAttribute("data-quiz-dates")) || [];
          const streakCount = calculateCurrentStreak(quizDates);
          streakTrackerSidebar.innerText = `Streak: ${streakCount} days`;
        }
      }
    }
    function closeSidebar() {
      const sidebar = document.getElementById("sidebar");
      if (sidebar) {
        sidebar.classList.remove("open");
      }
    }
    /****************************************************
     * Chatbot Functions
     ****************************************************/
    function closeChatbot() {
      const chatbotBox = document.getElementById("chatbot-box");
      if (chatbotBox) {
        chatbotBox.style.display = "none";
      }
    }
    // Update the AI Suggestions button to show the chatbot box.
    function getAISuggestions() {
      const chatbotBox = document.getElementById("chatbot-box");
      if (chatbotBox) {
        chatbotBox.style.display = "flex";
        // Optionally add an initial message
        addChatMessage("Hello! How can I help you with your quiz history today?", "ai");
      }
    }
    /****************************************************
     * Chatbot Message Handling
     ****************************************************/
    // Helper function to append messages to the chat
    function addChatMessage(message, sender) {
      const chatMessages = document.getElementById("chat-messages");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("chat-message", sender);
      msgDiv.innerText = message;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    // Function to send the user message
    function sendChatMessage() {
      const chatInput = document.getElementById("chat-input");
      const message = chatInput.value.trim();
      if (!message) return;
      addChatMessage(message, "user");
      fetch("/ai_suggs", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        addChatMessage(data.response || "No response", "ai");
      })
      .catch(error => {
        console.error("Error:", error);
        addChatMessage("Error: " + error, "ai");
      });
      chatInput.value = "";
    }
    /****************************************************
     * LOAD LAST & MAX SCORE
     ****************************************************/
    document.addEventListener("DOMContentLoaded", function () {
      const lastScore = "{{ last_score }}";
      const maxScore  = "{{ max_score }}";
      document.getElementById("lastScore").textContent = lastScore || "N/A";
      document.getElementById("maxScore").textContent  = maxScore || "N/A";
    });
    /****************************************************
     * RENDER BADGES
     ****************************************************/
    const badgeList = document.getElementById("badgeList");
    if (badgeMessages && badgeMessages.length > 0) {
      badgeMessages.forEach(msg => {
        const p = document.createElement("p");
        p.textContent = msg;
        badgeList.appendChild(p);
      });
    } else {
      const p = document.createElement("p");
      p.textContent = "No badges yet. Keep going!";
      badgeList.appendChild(p);
    }
    /****************************************************
     * RENDER QUIZ CARDS
     ****************************************************/
    if (UserData.quiz_attempts && Array.isArray(UserData.quiz_attempts) && UserData.quiz_attempts.length > 0) {
      UserData.quiz_attempts.forEach((attempt, idx) => {
        const quizCard = document.createElement("div");
        quizCard.classList.add("quiz-card");
        const title = document.createElement("h2");
        title.textContent = attempt.topic ? attempt.topic : `Quiz Attempt #${idx + 1}`;
        quizCard.appendChild(title);
        const meta = document.createElement("div");
        meta.classList.add("quiz-meta");
        const scoreText = attempt.score ? `Score: ${attempt.score}` : "Score: N/A";
        const typeText  = attempt.type ? `Type: ${attempt.type}` : "";
        const diffText  = attempt.difficulty ? `Difficulty: ${attempt.difficulty}` : "";
        const dateText  = attempt.date ? `Date: ${attempt.date}` : "";
        meta.textContent = [dateText, diffText, typeText, scoreText].join(" | ");
        quizCard.appendChild(meta);
        const quizPre = document.createElement("pre");
        quizPre.textContent = attempt.quiz_content || "No quiz content";
        quizPre.style.display = "none";
        quizCard.appendChild(quizPre);
        const expandBtn = document.createElement("button");
        expandBtn.textContent = "+";
        expandBtn.style.marginTop = "0.5rem";
        expandBtn.addEventListener("click", () => {
          if (quizPre.style.display === "none") {
            quizPre.style.display = "block";
            expandBtn.textContent = "−";
          } else {
            quizPre.style.display = "none";
            expandBtn.textContent = "+";
          }
        });
        quizCard.appendChild(expandBtn);
        quizzesContainer.appendChild(quizCard);
      });
    } else {
      const noQuizMsg = document.createElement("p");
      noQuizMsg.textContent = "No quizzes generated yet. Click 'Create new quiz' to get started!";
      quizzesContainer.appendChild(noQuizMsg);
    }
    /****************************************************
     * RENDER CALENDAR / STREAK TRACKER
     ****************************************************/
    const quizDatesElement = document.getElementById("quizDatesData");
    const quizDates = JSON.parse(quizDatesElement.getAttribute("data-quiz-dates")) || [];
    const highlightDates = quizDates.map(dateStr => {
      const [year, month, day] = dateStr.split('-');
      return new Date(year, month - 1, day);
    });
    const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    const calendar = document.getElementById("calendar");
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    let startingDayOfWeek = 2; // example start day

    daysInMonth.forEach((days, monthIndex) => {
      const monthContainer = document.createElement("div");
      monthContainer.className = "month-container";
      const monthLabel = document.createElement("div");
      monthLabel.className = "month-label";
      monthLabel.innerText = monthNames[monthIndex];
      monthContainer.appendChild(monthLabel);
      let dayOfWeek = (monthIndex === 0) ? startingDayOfWeek : (startingDayOfWeek % 7);
      let week = document.createElement("div");
      week.className = "week-row";
      for (let i = 0; i < dayOfWeek; i++) {
        const emptyBox = document.createElement("div");
        emptyBox.className = "day empty";
        week.appendChild(emptyBox);
      }
      for (let day = 1; day <= days; day++) {
        if (dayOfWeek === 7) {
          dayOfWeek = 0;
          monthContainer.appendChild(week);
          week = document.createElement("div");
          week.className = "week-row";
        }
        const dayBox = document.createElement("div");
        dayBox.className = "day";
        dayBox.title = `${monthNames[monthIndex]} ${day}`;
        const currentDay = new Date(2025, monthIndex, day);
        if (highlightDates.some(date => date.getTime() === currentDay.getTime())) {
          dayBox.classList.add("highlight");
        }
        const dayText = document.createElement("span");
        dayText.innerText = day;
        dayBox.appendChild(dayText);
        dayBox.addEventListener("click", () => {
          dayBox.classList.toggle("active");
        });
        week.appendChild(dayBox);
        dayOfWeek++;
      }
      if (week.children.length > 0) {
        monthContainer.appendChild(week);
      }
      calendar.appendChild(monthContainer);
      startingDayOfWeek = (startingDayOfWeek + days) % 7;
    });
    function calculateCurrentStreak(datesArray) {
      if (!datesArray || datesArray.length === 0) return 0;
      const uniqueDates = [...new Set(datesArray.map(d => {
        const dateObj = new Date(d);
        dateObj.setHours(0,0,0,0);
        return dateObj.toISOString().split('T')[0];
      }))];
      const sortedDates = uniqueDates.map(ds => new Date(ds)).sort((a,b) => a - b);
      if (sortedDates.length === 0) return 0;
      let streak = 1;
      for (let i = sortedDates.length - 1; i > 0; i--) {
        const diff = (sortedDates[i] - sortedDates[i - 1]) / (1000*60*60*24);
        if (diff === 1) {
          streak++;
        } else {
          break;
        }
      }
      return streak;
    }
  </script>
</body>
</html>
