<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* background-color: #f4f4f9; */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            background: 
        linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)),
        url('../static/image.png') no-repeat center center fixed;
    background-size: contain; /* Shows the entire image */
        }
        .quiz-container {
            /* background: #fff; */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 90%;
            max-width: 600px;
            justify-content: left;
        }
        .quiz-container h1 {
            /* color: #150f92; */
            margin-bottom: 20px;
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            font-size: 3.5rem;
            color: rgb(28, 6, 109);
            text-decoration: none;
            font-weight: bold;
            text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white;
        }
        .question {
            font-weight: bold;
            margin-top: 20px;
            color: white;
        }
        .options {
            margin: 10px 0;
            color: white;
        }
        .options label {
            display: block;
            margin: 5px 0;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .progress-bar {
            height: 10px;
            width: 100%;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            background: #4a41ff;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .nav-btn {
            padding: 10px 20px;
            background-color: #4a41ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .nav-btn:hover {
            background-color: #3732c1;
        }
        .result {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a41ff;
        }
        .hidden {
            display: none;
        }
        .options {
    text-align: left; /* Ensures the options container aligns content to the left */
    margin: 10px 0;
}

.options label {
    display: block; /* Forces each option to be on its own line */
    margin: 5px 0;
    cursor: pointer; /* Makes the label clickable */
}

.options input[type="radio"] {
    margin-right: 10px; /* Adds spacing between the radio button and the label text */
    vertical-align: middle; /* Aligns the radio button with the label text */
}

    </style>
</head>
<body>
    <div class="quiz-container">
        <h1>Good Luck ^-^ </h1>

        <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-bar-fill"></div>
        </div>

        <div id="quiz"></div>

        <div class="navigation">
            <button class="nav-btn hidden" id="prev-btn" onclick="navigate(-1)">Previous</button>
            <button class="nav-btn" id="next-btn" onclick="navigate(1)">Next</button>
            <button class="nav-btn hidden" id="submit-btn" onclick="submitQuiz()">Submit</button>
        </div>
        
        <div class="result" id="result"></div>
    </div>

    <script>
        // Extract URL parameters
const urlParams = new URLSearchParams(window.location.search);
const message = urlParams.get("message") || "No quiz data provided.";
const email = urlParams.get("email") || "No email provided.";
const difficulty = urlParams.get("difficulty") || "No difficulty provided.";

// Function to parse the message into questions
function parseQuestions(message) {
    const questionBlocks = message.split(/\*\*Question \d+:\*\*/).slice(1);
    return questionBlocks.map((block) => {
        const [questionPart, answerPart] = block.split("**Answer:**");
        const questionMatch = questionPart.match(/^(.*?)\n(.*?)$/s);
        const questionText = questionMatch[1].trim();
        const options = questionMatch[2]
            .trim()
            .split("\n")
            .map((opt) => opt.trim());
        const correctAnswer = answerPart.match(/[A-D]\)/)[0][0];
        return {
            question: questionText,
            options,
            correctAnswer,
        };
    });
}

// Parse the quiz questions
const questions = parseQuestions(message);

// DOM elements and state variables
const quizContainer = document.getElementById("quiz");
const progressBarFill = document.getElementById("progress-bar-fill");
let currentQuestion = 0;

// Array to store user's answers
const userAnswers = new Array(questions.length).fill(null);

function loadQuiz(index) {
    // Load the current question and options
    quizContainer.innerHTML = `
        <div class="question">${index + 1}. ${questions[index].question}</div>
        <div class="options">
            ${questions[index].options
                .map(
                    (option, i) => `
                    <label>
                        <input type="radio" name="question${index}" value="${String.fromCharCode(65 + i)}"
                        ${userAnswers[index] === String.fromCharCode(65 + i) ? "checked" : ""} />
                        ${option}
                    </label>
                `
                )
                .join("")}
        </div>
    `;
    updateProgress();
    updateNavigation();
}

function updateProgress() {
    // Update the progress bar width
    const progress = ((currentQuestion + 1) / questions.length) * 100;
    progressBarFill.style.width = `${progress}%`;
}

function updateNavigation() {
    // Show/hide navigation buttons based on current question index
    document.getElementById("prev-btn").classList.toggle("hidden", currentQuestion === 0);
    document.getElementById("next-btn").classList.toggle(
        "hidden",
        currentQuestion === questions.length - 1
    );
    document.getElementById("submit-btn").classList.toggle(
        "hidden",
        currentQuestion !== questions.length - 1
    );
}

function navigate(direction) {
    // Save the current selection
    const selectedOption = document.querySelector(`input[name="question${currentQuestion}"]:checked`);
    if (selectedOption) {
        userAnswers[currentQuestion] = selectedOption.value;
    }

    // Navigate to the next or previous question
    currentQuestion += direction;
    loadQuiz(currentQuestion);
}

function submitQuiz() {
    // Check if all questions have an answer selected
    const unanswered = userAnswers.some((answer) => answer === null);
    if (unanswered) {
        alert("Please answer all questions before submitting the quiz.");
        return; // Stop the submission process
    }

    let score = 0;

    // Evaluate the quiz results
    questions.forEach((q, index) => {
        const selectedAnswer = userAnswers[index];
        if (selectedAnswer) {
            if (selectedAnswer === q.correctAnswer) {
                score++;
            }
        }
    });

    // Display the result
    const resultContainer = document.getElementById("result");
    resultContainer.textContent = `You scored ${score} out of ${questions.length}!`;

    // Countdown timer
let countdown = 5;
const countdownContainer = document.createElement("p"); // Create a countdown element
resultContainer.appendChild(countdownContainer); // Add it below the result text

const countdownInterval = setInterval(() => {
    countdownContainer.textContent = `You will be redirected in ${countdown}...`;
    countdown--;

    if (countdown < 0) {
        clearInterval(countdownInterval); // Stop the countdown
        window.location.href = `/userProfile?email=${email}`; // Redirect after countdown
    }
}, 1000); // Update every second
    // Send results to the backend
    fetch("/insertResults", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            score: score,
            email: email,
            difficulty: difficulty
        }),
    })
        .then((response) => {
            if (response.ok) {
                window.location.href = `/userProfile?email=${email}`;
            } else {
                resultContainer.textContent = "Failed to submit your quiz. Please try again.";
            }
        })
        .catch(() => {
            resultContainer.textContent = "An error occurred. Please try again.";
        });
}

// Load the initial question
loadQuiz(currentQuestion);

    </script>
</body>
</html>
